<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chiknow - Lista HSK</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>

    <header>
        <h1>üèÆ Chiknow</h1>
        <p class="subtitle">Lista HSK 1 - Ê±âÂ≠óÂ≠¶‰π†</p>
    </header>

    <main id="content">
        <section id="hsk-section">
            <div class="section-header">
                <h2>Vocabulario HSK 1</h2>
                <div class="search-and-filters">
                    <div class="search-box">
                        <input type="text" id="search-input" placeholder="Buscar por hanzi, pinyin o espa√±ol...">
                        <button id="search-btn" class="search-button">üîç</button>
                    </div>
                    <div class="filter-buttons">
                        <button class="filter-btn active" data-filter="all">Todas</button>
                        <button class="filter-btn" data-filter="diccionario">En Diccionario</button>
                        <button class="filter-btn" data-filter="pendientes">Pendientes</button>
                    </div>
                </div>
            </div>
            <div id="lista-hsk"></div>
        </section>
    </main>

    <nav class="bottom-nav">
        <a href="/" class="nav-item active">
            <span class="nav-icon">3.0</span>
            <span class="nav-label">HSK</span>
        </a>
        <a href="/diccionario" class="nav-item">
            <span class="nav-icon">üìñ</span>
            <span class="nav-label">Diccionario</span>
        </a>
        <a href="/tarjetas" class="nav-item">
            <span>üóÇÔ∏è</span>
            <span class="nav-label">Tarjetas</span>
        </a>
        <a href="/sm2" class="nav-item">
            <span>üß†</span>
            <span class="nav-label">Estudiar</span>
        </a>
    </nav>

    <script>
        let todasLasPalabras = [];
        let filtroActual = 'all';
        let searchQuery = '';

        async function cargarHSK() {
            try {
                const res = await fetch('/api/hsk');
                todasLasPalabras = await res.json();
                renderizarPalabras();
            } catch (error) {
                console.error('Error al cargar HSK:', error);
                document.getElementById('lista-hsk').innerHTML = 
                    '<p class="error-message">Error al cargar las palabras.</p>';
            }
        }

        async function buscarPalabras(query) {
            try {
                const url = query ? `/api/hsk/search?query=${encodeURIComponent(query)}` : '/api/hsk';
                const res = await fetch(url);
                todasLasPalabras = await res.json();
                renderizarPalabras();
            } catch (error) {
                console.error('Error al buscar:', error);
            }
        }

        function renderizarPalabras() {
            const palabrasFiltradas = filtrarPalabras(todasLasPalabras, filtroActual);
            const contenedor = document.getElementById('lista-hsk');
            
            if (palabrasFiltradas.length === 0) {
                contenedor.innerHTML = '<p class="empty-message">No hay palabras que mostrar.</p>';
                return;
            }
            
            contenedor.innerHTML = palabrasFiltradas.map(p => `
                <div class="card ${p.en_diccionario ? 'en-diccionario' : ''}" data-id="${p.id}">
                    <div class="card-badge">
                        ${p.en_diccionario ? '<span class="badge-diccionario">‚úì En Diccionario</span>' : ''}
                    </div>
                    <div class="card-main-content">
                        <div class="hanzi-lg">${p.hanzi}</div>
                        <button class="btn-audio" onclick="reproducirAudio('${p.hanzi}')" title="Reproducir audio">üîä</button>
                    </div>
                    <div class="info">
                        <div class="pinyin">${p.pinyin}</div>
                        <div class="espanol">${p.espanol}</div>
                        <div class="numero-nivel">
                            <span class="numero">#${p.numero}</span>
                            <span class="nivel">HSK ${p.nivel}</span>
                        </div>
                    </div>
                    ${p.en_diccionario 
                        ? `<button class="btn-remove" onclick="eliminar(${p.id})" title="Eliminar">‚àí</button>`
                        : `<button class="btn-add" onclick="agregar(${p.id})" title="A√±adir">+</button>`
                    }
                </div>
            `).join('');
        }

        function filtrarPalabras(palabras, filtro) {
            switch(filtro) {
                case 'diccionario':
                    return palabras.filter(p => p.en_diccionario);
                case 'pendientes':
                    return palabras.filter(p => !p.en_diccionario);
                default:
                    return palabras;
            }
        }

        function reproducirAudio(texto) {
            // Usamos la API de Text-to-Speech del navegador
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(texto);
                utterance.lang = 'zh-CN'; // Chino mandar√≠n
                utterance.rate = 0.8; // Velocidad m√°s lenta para mejor comprensi√≥n
                window.speechSynthesis.speak(utterance);
            } else {
                mostrarNotificacion('Tu navegador no soporta s√≠ntesis de voz', 'error');
            }
        }

        async function agregar(id) {
            try {
                const res = await fetch(`/api/diccionario/add/${id}`, { method: 'POST' });
                const data = await res.json();
                
                if (data.error) {
                    mostrarNotificacion(data.error, 'error');
                } else {
                    mostrarNotificacion('‚úì A√±adida (6 tarjetas creadas)', 'success');
                    await cargarHSK();
                }
            } catch (error) {
                mostrarNotificacion('Error al a√±adir', 'error');
            }
        }

        async function eliminar(id) {
            if (!confirm('¬øEliminar palabra y sus 6 tarjetas?')) return;
            
            try {
                const res = await fetch(`/api/diccionario/remove/${id}`, { method: 'DELETE' });
                const data = await res.json();
                
                if (data.error) {
                    mostrarNotificacion(data.error, 'error');
                } else {
                    mostrarNotificacion('‚úì Eliminada', 'success');
                    await cargarHSK();
                }
            } catch (error) {
                mostrarNotificacion('Error al eliminar', 'error');
            }
        }

        function mostrarNotificacion(mensaje, tipo = 'info') {
            const notif = document.createElement('div');
            notif.className = `notificacion notificacion-${tipo}`;
            notif.textContent = mensaje;
            document.body.appendChild(notif);
            
            setTimeout(() => notif.classList.add('show'), 10);
            setTimeout(() => {
                notif.classList.remove('show');
                setTimeout(() => notif.remove(), 300);
            }, 3000);
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('search-input');
            const searchBtn = document.getElementById('search-btn');
            
            searchBtn.addEventListener('click', () => {
                searchQuery = searchInput.value.trim();
                buscarPalabras(searchQuery);
            });
            
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    searchQuery = searchInput.value.trim();
                    buscarPalabras(searchQuery);
                }
            });
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    filtroActual = e.target.dataset.filter;
                    renderizarPalabras();
                });
            });
        });

        window.onload = cargarHSK;
    </script>
</body>
</html>