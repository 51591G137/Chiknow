<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chiknow - Mi Diccionario</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>

    <header>
        <h1>üìñ Mi Diccionario</h1>
        <p class="subtitle">Palabras seleccionadas para estudio</p>
    </header>

    <main id="content">
        <section id="diccionario-section">
            <div class="section-header">
                <h2>Mis Palabras</h2>
                <div class="search-and-stats">
                    <div class="search-box">
                        <input type="text" id="search-input" placeholder="Buscar...">
                        <button id="search-btn" class="search-button">üîç</button>
                    </div>
                    <div class="stats">
                        <span class="stat-item">Total: <strong id="total-palabras">0</strong></span>
                    </div>
                </div>
            </div>
            <div id="lista-diccionario"></div>
        </section>
    </main>

    <nav class="bottom-nav">
        <a href="/" class="nav-item">
            <span class="nav-icon">3.0</span>
            <span class="nav-label">HSK</span>
        </a>
        <a href="/diccionario" class="nav-item active">
            <span class="nav-icon">üìñ</span>
            <span class="nav-label">Diccionario</span>
        </a>
        <a href="/ejemplos" class="nav-item">
            <span>üí¨</span>
            <span class="nav-label">Ejemplos</span>
        </a>
        <a href="/tarjetas" class="nav-item">
            <span>üóÇÔ∏è</span>
            <span class="nav-label">Tarjetas</span>
        </a>
        <a href="/sm2" class="nav-item">
            <span>üß†</span>
            <span class="nav-label">Estudiar</span>
        </a>
    </nav>

    <!-- Modal de Notas -->
    <div id="modal-notas" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="cerrarNotas()">‚úï</span>
            <h2>üìù Nota para <span id="nota-hanzi"></span></h2>
            <textarea id="textarea-nota" 
                      placeholder="Escribe tu nota aqu√≠ (mnemotecnia, contexto, observaciones...)&#10;&#10;Ejemplo: 'Se parece a una casa con techo'&#10;'Usar en contexto: ÊàëÂñúÊ¨¢‰Ω†'&#10;'No confundir con Â§™ (demasiado)'"
                      rows="8"></textarea>
            <div class="modal-actions">
                <button onclick="guardarNota()" class="btn btn-primary">
                    üíæ Guardar
                </button>
                <button onclick="eliminarNota()" class="btn btn-secondary">
                    üóëÔ∏è Eliminar
                </button>
            </div>
        </div>
    </div>

    <script>
        let todasLasPalabras = [];
        let notaActualHskId = null;

        async function cargarDiccionario() {
            try {
                const res = await fetch('/api/diccionario');
                todasLasPalabras = await res.json();
                renderizarDiccionario(todasLasPalabras);
            } catch (error) {
                console.error('Error al cargar diccionario:', error);
                document.getElementById('lista-diccionario').innerHTML = 
                    '<p class="error-message">Error al cargar el diccionario.</p>';
            }
        }

        async function buscarEnDiccionario(query) {
            try {
                const url = query ? `/api/diccionario/search?query=${encodeURIComponent(query)}` : '/api/diccionario';
                const res = await fetch(url);
                const palabras = await res.json();
                renderizarDiccionario(palabras);
            } catch (error) {
                console.error('Error al buscar:', error);
            }
        }

        function renderizarDiccionario(palabras) {
            document.getElementById('total-palabras').textContent = palabras.length;
            
            const contenedor = document.getElementById('lista-diccionario');
            
            if (palabras.length === 0) {
                const searchInput = document.getElementById('search-input');
                const hayBusqueda = searchInput && searchInput.value.trim() !== '';
                
                if (hayBusqueda) {
                    contenedor.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üîç</div>
                            <h3>No se encontraron resultados</h3>
                            <p>Intenta con otra b√∫squeda</p>
                        </div>
                    `;
                } else {
                    contenedor.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üìñ</div>
                            <h3>Tu diccionario est√° vac√≠o</h3>
                            <p>Ve a la lista HSK y a√±ade palabras para empezar a estudiar</p>
                            <a href="/" class="btn-primary">Ir a Lista HSK</a>
                        </div>
                    `;
                }
                return;
            }
            
            contenedor.innerHTML = palabras.map(p => `
                <div class="card diccionario-card">
                    <div class="card-main-content">
                        <div class="hanzi-lg">${p.hanzi}</div>
                        <button class="btn-audio" onclick="reproducirAudio('${p.hanzi}')" title="Reproducir audio">üîä</button>
                    </div>
                    <div class="info">
                        <div class="pinyin">${p.pinyin}</div>
                        <div class="espanol">${p.espanol}</div>
                        <div class="numero-nivel">
                            <span class="numero">#${p.numero}</span>
                            <span class="nivel">HSK ${p.nivel}</span>
                            <span class="tarjetas-count">6 tarjetas</span>
                        </div>
                    </div>
                    <div class="card-actions">
                        <button class="btn-nota" onclick="abrirNotas(${p.hsk_id}, '${p.hanzi}')" title="A√±adir/editar nota">
                            üìù
                        </button>
                        <button class="btn-remove" onclick="eliminar(${p.hsk_id})" title="Eliminar del diccionario">‚àì</button>
                    </div>
                </div>
            `).join('');
        }

        function reproducirAudio(texto) {
            if ('speechSynthesis' in window) {
                // Cancelar cualquier s√≠ntesis en curso
                window.speechSynthesis.cancel();
                
                // Limpiar texto
                const textoLimpio = texto
                    .replace(/['"`,;:!?]/g, '')
                    .replace(/\s+/g, ' ')
                    .trim();
                
                const utterance = new SpeechSynthesisUtterance(textoLimpio);
                utterance.lang = 'zh-CN';
                utterance.rate = 0.8;
                window.speechSynthesis.speak(utterance);
            } else {
                mostrarNotificacion('Tu navegador no soporta s√≠ntesis de voz', 'error');
            }
        }

        async function eliminar(hskId) {
            if (!confirm('¬øEst√°s seguro? Se eliminar√°n tambi√©n todas las tarjetas de esta palabra.')) {
                return;
            }
            
            try {
                const res = await fetch(`/api/diccionario/remove/${hskId}`, { 
                    method: 'DELETE'
                });
                const data = await res.json();
                
                if (data.error) {
                    mostrarNotificacion(data.error, 'error');
                } else {
                    mostrarNotificacion('‚úì Palabra eliminada', 'success');
                    await cargarDiccionario();
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('Error al eliminar', 'error');
            }
        }

        // ========================================================================
        // SISTEMA DE NOTAS
        // ========================================================================

        async function abrirNotas(hskId, hanzi) {
            notaActualHskId = hskId;
            document.getElementById('nota-hanzi').textContent = hanzi;
            
            // Cargar nota existente
            try {
                const res = await fetch(`/api/hsk/${hskId}/nota`);
                const data = await res.json();
                document.getElementById('textarea-nota').value = data.nota || '';
            } catch (error) {
                console.error('Error cargando nota:', error);
                document.getElementById('textarea-nota').value = '';
            }
            
            document.getElementById('modal-notas').classList.add('show');
            
            // Enfocar el textarea
            setTimeout(() => {
                document.getElementById('textarea-nota').focus();
            }, 100);
        }

        function cerrarNotas() {
            document.getElementById('modal-notas').classList.remove('show');
            notaActualHskId = null;
        }

        async function guardarNota() {
            const nota = document.getElementById('textarea-nota').value.trim();
            
            if (!nota) {
                mostrarNotificacion('Escribe una nota primero', 'error');
                return;
            }
            
            try {
                const res = await fetch(`/api/hsk/${notaActualHskId}/nota`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nota })
                });
                
                const data = await res.json();
                
                if (data.error) {
                    mostrarNotificacion(data.error, 'error');
                } else {
                    mostrarNotificacion('‚úì Nota guardada', 'success');
                    cerrarNotas();
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('Error al guardar nota', 'error');
            }
        }

        async function eliminarNota() {
            if (!confirm('¬øEliminar esta nota?')) return;
            
            try {
                const res = await fetch(`/api/hsk/${notaActualHskId}/nota`, {
                    method: 'DELETE'
                });
                
                const data = await res.json();
                
                if (data.error) {
                    mostrarNotificacion(data.error, 'error');
                } else {
                    mostrarNotificacion('‚úì Nota eliminada', 'success');
                    document.getElementById('textarea-nota').value = '';
                    cerrarNotas();
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('Error al eliminar nota', 'error');
            }
        }

        function mostrarNotificacion(mensaje, tipo = 'info') {
            const notif = document.createElement('div');
            notif.className = `notificacion notificacion-${tipo}`;
            notif.textContent = mensaje;
            document.body.appendChild(notif);
            
            setTimeout(() => notif.classList.add('show'), 10);
            setTimeout(() => {
                notif.classList.remove('show');
                setTimeout(() => notif.remove(), 300);
            }, 3000);
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('search-input');
            const searchBtn = document.getElementById('search-btn');
            
            searchBtn.addEventListener('click', () => {
                buscarEnDiccionario(searchInput.value.trim());
            });
            
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    buscarEnDiccionario(searchInput.value.trim());
                }
            });

            // Cerrar modal al hacer clic fuera
            document.getElementById('modal-notas').addEventListener('click', (e) => {
                if (e.target.id === 'modal-notas') {
                    cerrarNotas();
                }
            });

            // Atajo de teclado ESC para cerrar modal
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    cerrarNotas();
                }
            });
        });

        window.onload = cargarDiccionario;
    </script>
</body>
</html>