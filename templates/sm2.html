<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chiknow - Estudiar SM2</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>

    <header>
        <h1>üß† Sistema de Estudio SM2</h1>
        <p class="subtitle">Repaso espaciado inteligente (0-2)</p>
    </header>

    <main id="content">
        <!-- Vista de estad√≠sticas -->
        <section id="stats-section">
            <div class="sm2-dashboard">
                <div class="stat-card">
                    <div class="stat-number" id="pendientes-hoy">0</div>
                    <div class="stat-label">Pendientes Hoy</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="tarjetas-nuevas">0</div>
                    <div class="stat-label">Tarjetas Nuevas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-estudiadas">0</div>
                    <div class="stat-label">Total Estudiadas</div>
                </div>
            </div>
            
            <div class="action-center">
                <button id="btn-iniciar-estudio" class="btn-large btn-primary">
                    üöÄ Iniciar Sesi√≥n de Estudio
                </button>
                <button id="btn-ver-progreso" class="btn-large btn-secondary">
                    üìä Ver Progreso Detallado
                </button>
            </div>
        </section>

        <!-- Vista de estudio -->
        <section id="study-section" style="display: none;">
            <div class="study-header">
                <div class="study-info">
                    <span class="study-progress">
                        <span id="current-card">0</span> / <span id="total-cards">0</span>
                    </span>
                    <span class="card-type-badge" id="card-type-badge"></span>
                </div>
                <button id="btn-salir-estudio" class="btn-small btn-secondary">Salir</button>
            </div>

            <div class="flashcard">
                <!-- Frente de la tarjeta -->
                <div class="flashcard-front" id="flashcard-front">
                    <div class="card-content">
                        <div id="mostrado1" class="display-text"></div>
                        <div id="mostrado2" class="display-text secondary"></div>
                        <button id="btn-audio" class="btn-audio-large" style="display: none;">üîä Reproducir</button>
                    </div>
                </div>

                <!-- Reverso de la tarjeta -->
                <div class="flashcard-back" id="flashcard-back" style="display: none;">
                    <div class="card-answer">
                        <h3>Respuesta:</h3>
                        <div id="answer-text" class="answer-display"></div>
                    </div>
                    
                    <!-- Selector de hanzi fallados (solo para ejemplos) -->
                    <div id="hanzi-selector" class="hanzi-selector" style="display: none;">
                        <p class="selector-label">¬øQu√© hanzi te caus√≥ problema? (opcional)</p>
                        <div id="hanzi-chips" class="hanzi-chips-container"></div>
                        <label class="frase-fallada-check">
                            <input type="checkbox" id="check-frase-fallada">
                            <span>Fall√© la estructura de la frase</span>
                        </label>
                    </div>
                    
                    <!-- Botones de calidad (0-2) -->
                    <div class="quality-buttons">
                        <p class="quality-label">¬øQu√© tan bien lo recordaste?</p>
                        <div class="quality-grid-simple">
                            <button class="quality-btn-simple q0" onclick="responder(0)">
                                <span class="q-emoji">üòµ</span>
                                <span class="q-text">Again</span>
                                <span class="q-subtext">No record√©</span>
                            </button>
                            <button class="quality-btn-simple q1" onclick="responder(1)">
                                <span class="q-emoji">üòê</span>
                                <span class="q-text">Hard</span>
                                <span class="q-subtext">Con dificultad</span>
                            </button>
                            <button class="quality-btn-simple q2" onclick="responder(2)">
                                <span class="q-emoji">üòä</span>
                                <span class="q-text">Easy</span>
                                <span class="q-subtext">F√°cilmente</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flip-button-container">
                <button id="btn-voltear" class="btn-flip">Mostrar Respuesta</button>
            </div>
        </section>

        <!-- Vista de progreso -->
        <section id="progress-section" style="display: none;">
            <div class="progress-header">
                <h2>Progreso Detallado</h2>
                <button id="btn-volver-stats" class="btn-secondary">‚Üê Volver</button>
            </div>
            <div id="progress-list"></div>
        </section>

        <!-- Resultado de sesi√≥n -->
        <section id="result-section" style="display: none;">
            <div class="result-card">
                <h2>üéâ ¬°Sesi√≥n Completada!</h2>
                <div class="result-stats">
                    <div class="result-item">
                        <span class="result-label">Tarjetas estudiadas:</span>
                        <span class="result-value" id="result-total">0</span>
                    </div>
                    <div class="result-item success">
                        <span class="result-label">Correctas (‚â•1):</span>
                        <span class="result-value" id="result-correctas">0</span>
                    </div>
                    <div class="result-item error">
                        <span class="result-label">Incorrectas (0):</span>
                        <span class="result-value" id="result-incorrectas">0</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Porcentaje de acierto:</span>
                        <span class="result-value" id="result-porcentaje">0%</span>
                    </div>
                </div>
                <div class="result-actions">
                    <button id="btn-nueva-sesion" class="btn-primary">Nueva Sesi√≥n</button>
                    <button id="btn-volver-inicio" class="btn-secondary">Volver al Inicio</button>
                </div>
            </div>
        </section>
    </main>

    <nav class="bottom-nav">
        <a href="/" class="nav-item">
            <span class="nav-icon">3.0</span>
            <span class="nav-label">HSK</span>
        </a>
        <a href="/diccionario" class="nav-item">
            <span class="nav-icon">üìñ</span>
            <span class="nav-label">Diccionario</span>
        </a>
        <a href="/ejemplos" class="nav-item">
            <span>üí¨</span>
            <span class="nav-label">Ejemplos</span>
        </a>
        <a href="/tarjetas" class="nav-item">
            <span>üóÇÔ∏è</span>
            <span class="nav-label">Tarjetas</span>
        </a>
        <a href="/sm2" class="nav-item active">
            <span>üß†</span>
            <span class="nav-label">Estudiar</span>
        </a>
    </nav>

    <script>
        let sessionId = null;
        let tarjetasEstudio = [];
        let indiceActual = 0;
        let tarjetaActual = null;
        let mostrandoRespuesta = false;
        let hanziSeleccionados = [];

        async function cargarEstadisticas() {
            try {
                const res = await fetch('/api/sm2/statistics');
                const stats = await res.json();
                
                document.getElementById('pendientes-hoy').textContent = stats.tarjetas_pendientes_hoy;
                document.getElementById('tarjetas-nuevas').textContent = stats.tarjetas_nuevas;
                document.getElementById('total-estudiadas').textContent = stats.tarjetas_estudiadas;
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function iniciarSesion() {
            try {
                const resSession = await fetch('/api/sm2/session/start', { method: 'POST' });
                const sessionData = await resSession.json();
                sessionId = sessionData.session_id;
                
                const resTarjetas = await fetch('/api/sm2/cards/due?limite=20');
                tarjetasEstudio = await resTarjetas.json();
                
                if (tarjetasEstudio.length === 0) {
                    mostrarNotificacion('¬°No hay tarjetas pendientes!', 'info');
                    return;
                }
                
                mostrarSeccion('study');
                indiceActual = 0;
                mostrarTarjeta();
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('Error al iniciar sesi√≥n', 'error');
            }
        }

        function mostrarTarjeta() {
            if (indiceActual >= tarjetasEstudio.length) {
                finalizarSesion();
                return;
            }
            
            tarjetaActual = tarjetasEstudio[indiceActual];
            mostrandoRespuesta = false;
            hanziSeleccionados = [];
            
            // Actualizar progreso
            document.getElementById('current-card').textContent = indiceActual + 1;
            document.getElementById('total-cards').textContent = tarjetasEstudio.length;
            
            // Badge de tipo
            const badge = document.getElementById('card-type-badge');
            badge.textContent = tarjetaActual.tipo === 'ejemplo' ? 'üí¨ Ejemplo' : 'üìù Palabra';
            badge.className = 'card-type-badge ' + (tarjetaActual.tipo === 'ejemplo' ? 'badge-ejemplo' : 'badge-palabra');
            
            // Mostrar contenido
            const mostrado1 = document.getElementById('mostrado1');
            const mostrado2 = document.getElementById('mostrado2');
            const btnAudio = document.getElementById('btn-audio');
            
            mostrado1.textContent = tarjetaActual.mostrado1 || '';
            mostrado1.style.display = tarjetaActual.mostrado1 ? 'block' : 'none';
            
            mostrado2.textContent = tarjetaActual.mostrado2 || '';
            mostrado2.style.display = tarjetaActual.mostrado2 ? 'block' : 'none';
            
            btnAudio.style.display = tarjetaActual.audio ? 'block' : 'none';
            
            // Audio autom√°tico si es solo audio
            if (tarjetaActual.audio && !tarjetaActual.mostrado1 && !tarjetaActual.mostrado2) {
                setTimeout(() => reproducirAudio(tarjetaActual.hanzi), 500);
            }
            
            // Mostrar frente
            document.getElementById('flashcard-front').style.display = 'block';
            document.getElementById('flashcard-back').style.display = 'none';
            document.getElementById('btn-voltear').style.display = 'block';
        }

        function voltearTarjeta() {
            if (mostrandoRespuesta) return;
            
            mostrandoRespuesta = true;
            document.getElementById('answer-text').textContent = tarjetaActual.requerido;
            
            // Mostrar selector de hanzi si es ejemplo
            const hanziSelector = document.getElementById('hanzi-selector');
            if (tarjetaActual.tipo === 'ejemplo' && tarjetaActual.hanzi_componentes) {
                hanziSelector.style.display = 'block';
                renderizarHanziChips(tarjetaActual.hanzi_componentes);
            } else {
                hanziSelector.style.display = 'none';
            }
            
            document.getElementById('flashcard-front').style.display = 'none';
            document.getElementById('flashcard-back').style.display = 'block';
            document.getElementById('btn-voltear').style.display = 'none';
        }

        function renderizarHanziChips(hanziList) {
            const container = document.getElementById('hanzi-chips');
            container.innerHTML = hanziList.map(h => `
                <label class="hanzi-chip-selectable">
                    <input type="checkbox" value="${h}" onchange="toggleHanzi('${h}')">
                    <span class="hanzi-text">${h}</span>
                </label>
            `).join('');
            document.getElementById('check-frase-fallada').checked = false;
        }

        function toggleHanzi(hanzi) {
            const index = hanziSeleccionados.indexOf(hanzi);
            if (index > -1) {
                hanziSeleccionados.splice(index, 1);
            } else {
                hanziSeleccionados.push(hanzi);
            }
        }

        async function responder(quality) {
            try {
                const fraseF allada = document.getElementById('check-frase-fallada')?.checked || false;
                
                const payload = {
                    tarjeta_id: tarjetaActual.tarjeta_id,
                    session_id: sessionId,
                    quality: quality,
                    hanzi_fallados: hanziSeleccionados.length > 0 ? hanziSeleccionados : null,
                    frase_fallada: fraseFallada
                };
                
                const res = await fetch('/api/sm2/review', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const resultado = await res.json();
                
                const mensaje = resultado.es_correcta 
                    ? `‚úì Pr√≥ximo repaso en ${resultado.nuevo_intervalo} d√≠as (${resultado.nuevo_estado})`
                    : '‚úó Necesita m√°s pr√°ctica';
                mostrarNotificacion(mensaje, resultado.es_correcta ? 'success' : 'warning');
                
                indiceActual++;
                setTimeout(mostrarTarjeta, 300);
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('Error al procesar respuesta', 'error');
            }
        }

        async function finalizarSesion() {
            try {
                const res = await fetch(`/api/sm2/session/end/${sessionId}`, { method: 'POST' });
                const resultado = await res.json();
                
                document.getElementById('result-total').textContent = resultado.tarjetas_estudiadas;
                document.getElementById('result-correctas').textContent = resultado.correctas;
                document.getElementById('result-incorrectas').textContent = resultado.incorrectas;
                document.getElementById('result-porcentaje').textContent = resultado.porcentaje_acierto + '%';
                
                mostrarSeccion('result');
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function verProgreso() {
            try {
                const res = await fetch('/api/sm2/progress');
                const progreso = await res.json();
                
                const contenedor = document.getElementById('progress-list');
                
                if (progreso.length === 0) {
                    contenedor.innerHTML = '<p class="empty-message">No hay progreso a√∫n</p>';
                } else {
                    contenedor.innerHTML = progreso.map(p => `
                        <div class="progress-card ${p.activa ? '' : 'inactiva'}">
                            <div class="progress-header">
                                <span class="progress-hanzi">${p.hanzi || 'Ejemplo'}</span>
                                ${p.pinyin ? `<span class="progress-pinyin">${p.pinyin}</span>` : ''}
                                ${!p.activa ? '<span class="badge-pausada">‚è∏Ô∏è Pausada</span>' : ''}
                            </div>
                            <div class="progress-details">
                                <div class="progress-stat">
                                    <span class="label">Estado:</span>
                                    <span class="value estado-${p.estado}">${p.estado}</span>
                                </div>
                                <div class="progress-stat">
                                    <span class="label">Facilidad:</span>
                                    <span class="value">${p.facilidad}</span>
                                </div>
                                <div class="progress-stat">
                                    <span class="label">Repeticiones:</span>
                                    <span class="value">${p.repeticiones}</span>
                                </div>
                                <div class="progress-stat">
                                    <span class="label">Intervalo:</span>
                                    <span class="value">${p.intervalo_dias} d√≠as</span>
                                </div>
                                <div class="progress-stat">
                                    <span class="label">Acierto:</span>
                                    <span class="value success">${p.tasa_acierto}%</span>
                                </div>
                            </div>
                            <div class="progress-footer">
                                <span class="next-review">Pr√≥xima: ${formatearFecha(p.proxima_revision)}</span>
                            </div>
                        </div>
                    `).join('');
                }
                
                mostrarSeccion('progress');
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function mostrarSeccion(seccion) {
            document.getElementById('stats-section').style.display = seccion === 'stats' ? 'block' : 'none';
            document.getElementById('study-section').style.display = seccion === 'study' ? 'block' : 'none';
            document.getElementById('progress-section').style.display = seccion === 'progress' ? 'block' : 'none';
            document.getElementById('result-section').style.display = seccion === 'result' ? 'block' : 'none';
        }

        function reproducirAudio(texto) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(texto);
                utterance.lang = 'zh-CN';
                utterance.rate = 0.8;
                window.speechSynthesis.speak(utterance);
            }
        }

        function formatearFecha(isoString) {
            const fecha = new Date(isoString);
            const ahora = new Date();
            const diff = Math.ceil((fecha - ahora) / (1000 * 60 * 60 * 24));
            
            if (diff < 0) return 'Vencida';
            if (diff === 0) return 'Hoy';
            if (diff === 1) return 'Ma√±ana';
            return `En ${diff} d√≠as`;
        }

        function mostrarNotificacion(mensaje, tipo = 'info') {
            const notif = document.createElement('div');
            notif.className = `notificacion notificacion-${tipo}`;
            notif.textContent = mensaje;
            document.body.appendChild(notif);
            
            setTimeout(() => notif.classList.add('show'), 10);
            setTimeout(() => {
                notif.classList.remove('show');
                setTimeout(() => notif.remove(), 300);
            }, 3000);
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('btn-iniciar-estudio').addEventListener('click', iniciarSesion);
            document.getElementById('btn-ver-progreso').addEventListener('click', verProgreso);
            document.getElementById('btn-voltear').addEventListener('click', voltearTarjeta);
            document.getElementById('btn-audio').addEventListener('click', () => reproducirAudio(tarjetaActual.hanzi));
            document.getElementById('btn-salir-estudio').addEventListener('click', () => {
                if (confirm('¬øSalir? El progreso se guardar√°.')) {
                    if (sessionId) finalizarSesion();
                    else mostrarSeccion('stats');
                }
            });
            document.getElementById('btn-volver-stats').addEventListener('click', () => mostrarSeccion('stats'));
            document.getElementById('btn-nueva-sesion').addEventListener('click', () => {
                mostrarSeccion('stats');
                cargarEstadisticas();
            });
            document.getElementById('btn-volver-inicio').addEventListener('click', () => {
                mostrarSeccion('stats');
                cargarEstadisticas();
            });
        });

        window.onload = cargarEstadisticas;
    </script>
</body>
</html>